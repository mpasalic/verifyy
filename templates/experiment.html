{% extends 'base.html' %}

{% block title %}Experiment{% endblock %}

{% block extrahead %}

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7; IE=EmulateIE9">

<script type="text/javascript" src="http://dygraphs.com/dygraph-combined.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
    google.load('visualization', '1', {packages: ['corechart']});
</script>

<!--[if IE]>
<script type="text/javascript" src="static/Charts/excanvas.js"></script>
<![endif]-->

<style type="text/css">
.inputtxt {
    width: 96%;
    padding-right: 30;
    padding-left: 10;
}
.inputselect {
    width: 96%;
    padding-right: 30;
    padding-left: 10;
}
</style>
<script language="javascript">
function vote(val) {
		
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			xml = xmlhttp.responseXML
			total = xml.getElementsByTagName("total")[0]
			document.getElementById("votetotal").innerHTML=total.childNodes[0].nodeValue;
		}
	}
	  
	if (val) {
		xmlhttp.open("GET","/upvote/{{ exp.id }}/",true);
	} else {
		xmlhttp.open("GET","/downvote/{{ exp.id }}/",true);
	}
	xmlhttp.send();
}

/*
 function drawChartOLD(xmldata) {
	var data = new google.visualization.DataTable();
	
	var chartElement = xmldata.getElementsByTagName("chart")[0];
	
	data.addColumn('number', chartElement.getAttribute("xAxisName"));
	data.addColumn('number', chartElement.getAttribute("yAxisName"));
	data.addColumn({type:'string', role:'tooltip'});
	
	var datasetElement = xmldata.getElementsByTagName("dataset")[0];
	var dataElements = datasetElement.getElementsByTagName("set");

	data.addRows(dataElements.length);
 
	for (var i = 0; i < dataElements.length; i++) {
		var dataElement = dataElements[i];
		var x = dataElement.getAttribute("x");
		var y = dataElement.getAttribute("y");
		data.setCell(i, 0, parseFloat(x));
		data.setCell(i, 1, parseFloat(y));
		data.setCell(i, 2, dataElement.getAttribute("tooltext"));
	}

	var xmin = parseFloat(xmldata.getElementsByTagName("xmin")[0].nodeValue);
	var xmax = parseFloat(xmldata.getElementsByTagName("xmax")[0].nodeValue);
	var ymin = parseFloat(xmldata.getElementsByTagName("ymin")[0].nodeValue);
	var ymax = parseFloat(xmldata.getElementsByTagName("ymax")[0].nodeValue);
	
	var options = {
	  chartArea: {left:40,top:30,bottom:40, width:"90%",height:"75%"},
	  hAxis: {title: chartElement.getAttribute("xAxisName"), minValue: xmin , maxValue: xmax },
	  vAxis: {title: chartElement.getAttribute("yAxisName"), minValue: ymin , maxValue: ymax },
	  legend: 'none'
	};
	
	var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
	chart.draw(data, options);
	
	document.getElementById("experiment_data_points").innerHTML = dataElements.length;
	total = xmldata.getElementsByTagName("regression")[0];
	document.getElementById("experiment_regression_summary").innerHTML=total.childNodes[0].nodeValue;
}*/

function loadLabelMapping(xmldata, v) {
	var mappingNodes = xmldata.getElementsByTagName(v + '_mapping');
	if (mappingNodes.length == 0) return {};
	var mappingNode = mappingNodes[0];
	var mappings = mappingNode.getElementsByTagName('mapping');
	var mapping = {};
	for (var i = 0; i < mappings.length; ++i) {
        var num = mappings[i].getAttribute('from');
        var label = mappings[i].getAttribute('to');
        mapping[num] = label;
    }
	return mapping;
}

function drawColumnChart(xmldata) {
    var xMapping = {};
    var yMapping = {};
    
    //1. Load label mapping parameters
    {
        xMapping = loadLabelMapping(xmldata, 'x');
		yMapping = loadLabelMapping(xmldata, 'y');
    }
    // /1. Mappings parameters loaded
    // 2. Reconstruct table
    var table = {};
    
    for (var key in xMapping) {
        table[key] = {};
        for (var key2 in yMapping) {
            table[key][key2] = 0;
        }
    }
    
    var entriesWrap = xmldata.getElementsByTagName('tally')[0];
    var entries = entriesWrap.getElementsByTagName('cell');
    var total = 0;
    for (var i = 0; i < entries.length; ++i) {
        var xC = entries[i].getAttribute('row');
        var yC = entries[i].getAttribute('col');
        var val = parseInt(entries[i].getAttribute('count')); 
        table[xC][yC] = val;
        total += val;
    }
    
    if (total == 0) {
        throw "Insufficient Data To Display!";
    }
    
    // 3. Draw the data!
    var data = new google.visualization.DataTable();
    
    data.addColumn('string', 'TODO_axis');
    for (var yAlias in yMapping) {
        data.addColumn('number', yMapping[yAlias]);
    }
    
    for (var xAlias in xMapping) {
        var row = [xMapping[xAlias]];
        for (yAlias in yMapping) {
            row.push(table[xAlias][yAlias]);
        }
        data.addRows([
            row
        ]);
    }
    
    var options = {
        vAxis: {baseline: 0}
    };
    var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
    chart.draw(data, options);
}


function drawCandleStickChart(xmldata) {
    var labels = [
        xmldata.getElementsByTagName('chart')[0].getAttribute('xAxisName'), 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yAxisName')
    ];
    var yAxisText = 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yAxisName') + ", " + 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yUnits');

    var chartCaption = xmldata.getElementsByTagName('chart')[0].getAttribute('caption');

    
    var mapping = {};
    var data = [];
    
    var mappingNode = xmldata.getElementsByTagName('x_mapping')[0];
    var x_mappings = mappingNode.getElementsByTagName('mapping');
    
    for (var i = 0; i < x_mappings.length; ++i) {
        var levelBin = x_mappings[i].getAttribute('from');
        var levelBinStr = x_mappings[i].getAttribute('to');
        mapping[levelBin] = levelBinStr;
    }
    
    var extraElement = xmldata.getElementsByTagName("extra")[0];
	var candles = extraElement.getElementsByTagName("candle");
    
    for (var i = 0; i < candles.length; ++i) {
        var candle = candles[i];
        var alias =  candle.getAttribute('bin');
        var label = mapping[ alias ];
        var bmin = parseFloat(candle.getAttribute('min'));
        var bmax = parseFloat(candle.getAttribute('max'));
        var bMSigma = parseFloat(candle.getAttribute('open'));
        var bPSigma = parseFloat(candle.getAttribute('close'));
        data.push([label, bmin, bMSigma, bPSigma, bmax]);
    }
    
    if (data.length == 0) {
        throw "No data avaialble to display!";
    }
    
	var dataTbl = google.visualization.arrayToDataTable(data, true);
    
    var options = {
        legend:'none',
        title: chartCaption,
        hAxis: { title: labels[0] },
        vAxis: { title: yAxisText }
    };
    
    var chart = new google.visualization.CandlestickChart(document.getElementById('chart_div'));
    chart.draw(dataTbl, options);
}

function padZero(num) {
    str = "" + num;
    if (str.length == 1) {
        str = "0" + str;
    }
    return str;
}

function getTimeParserFunc(timefold) {
    var funHourly = function(nsecs) {
        var timeObj = new Date();
        timeObj.setYear(2005);
        timeObj.setMonth(11);
        timeObj.setDate(12);
        timeObj.setHours(0);
        timeObj.setMinutes(Math.floor(nsecs / 60));
        nsecs = nsecs % 60;
        timeObj.setSeconds(nsecs);
        timeObj.setMilliseconds(0);
        return timeObj;
    };
    if (timefold == 'Hourly') return funHourly;
    
    var funDaily = function(nsecs) {
        var hours = (nsecs / (60*60));
        var timeObj = funHourly(nsecs % (60*60));
        timeObj.setHours(hours);
        return timeObj;
    };
    if (timefold == 'Daily') return funDaily;
    
    var funWeekly = function(nsecs) {
        var dayOfTheWeek = Math.floor( nsecs / (60*60*24) );
        var timeObj = funDaily(nsecs % (24*60*60));
        timeObj.setDate(12 + dayOfTheWeek);
        return timeObj;
    };
    
    if (timefold == 'Weekly') return funWeekly;
    
    var funByDefault = function(nsecs) {
        return new Date(Math.floor(nsecs*1000));
    }
}

function getDateToStringFunc(timefold, maxDeltaSecs) {
    // Use max delta to figure out the proper resolution
    var funHourly = function(timeObj) {
        return padZero(timeObj.getMinutes()) + ":" + padZero(timeObj.getSeconds());
    };
    if (maxDeltaSecs < 60*60) return funHourly;

    var funDaily = function(timeObj) {
        return padZero(timeObj.getHours()) + ":" + padZero(timeObj.getMinutes());
    };
    if (maxDeltaSecs < 24*60*60) return funDaily;
    
    
    if (timefold == 'Weekly') {
        var daysOfWeek = [
            "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"
        ];
        
        var funWeekly = function(timeObj) {
            return daysOfWeek[ timeObj.getDay() ] + " " + funDaily(timeObj);
        };
        
        return funWeekly;
    } else {
        var funDate = function(timeObj) {
            return  timeObj.getYear()
            + "/" + padZero(timeObj.getMonth()) 
            + "/" + padZero(timeObj.getDate());
        };
        
        var funByDefault = function(timeObj) {
            return  padZero(timeObj.getFullYear()) 
            + "-" + padZero(timeObj.getMonth()) 
            + "-" + padZero(timeObj.getDate())
            + " " + funDaily(timeObj);
        };
        
        return funByDefault;
    }
}

function getFormatterFunc(timefold, maxdelta) {
    if (timefold == null) {
        // This is just a regular real-value formatter
        return function(x) {
            return x.toPrecision(4);
        };
    } else {
        // We need a super-special time formatter
        var parserFunc = getTimeParserFunc(timefold);
        var formatterFunc = getDateToStringFunc(timefold, maxdelta);
        return function(nsecs) {
            return formatterFunc(parserFunc(nsecs));
        };    
    }
}

function formatForServerInUTCString(dateObj) {
    return dateObj.getUTCFullYear() 
    + "-" + padZero(dateObj.getUTCMonth()) 
    + "-" + padZero(dateObj.getUTCDate()) 
    + " " + padZero(dateObj.getUTCHours()) 
    + ":" + padZero(dateObj.getUTCMinutes()) 
    + ":" + padZero(dateObj.getUTCSeconds()) 
    + " UTC";
}

function drawChart(xmldata) {
    //0. Prepare for 'unfolding' time series data: create an appropriate function
    var folding_kind = xmldata.getElementsByTagName("timefold");
    if (folding_kind.length > 0) {
        folding_kind = folding_kind[0].getAttribute('period');
    } else {
        folding_kind = null;
    }
    
    var xmax = xmldata.getElementsByTagName("xmax")[0].childNodes[0].nodeValue;
    var xmin = xmldata.getElementsByTagName("xmin")[0].childNodes[0].nodeValue;
    var ymax = xmldata.getElementsByTagName("ymax")[0].childNodes[0].nodeValue;
    var ymin = xmldata.getElementsByTagName("ymin")[0].childNodes[0].nodeValue;

    var deltaX = parseFloat(xmax) - parseFloat(xmin);
    var deltaY = parseFloat(ymax) - parseFloat(ymin);
    
    //1. Fill in the data array
    var datasetElement = xmldata.getElementsByTagName("dataset")[0];
	var dataElements = datasetElement.getElementsByTagName("set");
    
    var data = [];
    
    for (var i = 0; i < dataElements.length; ++i) {
        var x = parseFloat(dataElements[i].getAttribute("x"));
        var y = parseFloat(dataElements[i].getAttribute("y"));
        var entry = [x, y];
        data.push(entry);
    }
    
    if (data.length == 0) {
        throw "No data to display!";
    }
    
    
    //1.1 Sort All Data To be On the safe side
    data.sort(function(p1,p2){ return p1[0] - p2[0]; });
    
    //2. Data Array Filled.
    //   Create labels
    var labels = [
        xmldata.getElementsByTagName('chart')[0].getAttribute('xAxisName'), 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yAxisName')
    ];
    var xAxisText = 
        xmldata.getElementsByTagName('chart')[0].getAttribute('xAxisName') + " (" +
        xmldata.getElementsByTagName('chart')[0].getAttribute('xUnits') + ")";
    
    var yAxisText = 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yAxisName') + " (" + 
        xmldata.getElementsByTagName('chart')[0].getAttribute('yUnits') + ")";
    var chartCaption = xmldata.getElementsByTagName('chart')[0].getAttribute('caption');
    
    var orig_colors = [];
    
    //3. Draw Scatter Plot of data points
    graph = new Dygraph(
        document.getElementById('chart_div'),
        data,
        {
			title: "",
            labels: labels,
            drawPoints: true,
            avoidMinZero:true,
            pointSize: 4,
            highlightCircleSize: 5,
            strokeWidth: 0.0,
			labelsDivWidth: 500,
			labelsDivStyles: { 'text-align': 'right' },
			
            drawCallback: function(g, is_initial) {
                if (!is_initial) { return; }
                var c = g.getColors();
                for (var i = 0; i < c.length; i++) orig_colors.push(c[i]);
            }
        }
    );
    
    //4. Compute the points to draw the piecewise parametric curve over data.
    //   The way this works is that a parametric curve is a vector function
    //   [x, y] = f(t). We use xml to pass function(t, [i]) {} functions to plot here
    //
    //   Also, i is the optional parameter denoting the index of interval to draw.
    //   0..tranges intervals are processed
    //   
    //   We also need to insert points from the original data
    //
    //
    //   TODO: Make original points insertion code more efficient? Also, we destroy data
    var pc_data = [];
    
    var pcurve = xmldata.getElementsByTagName('parametric_curve')[0]; //Can always add more later
    var tranges = parseInt(pcurve.getElementsByTagName('t_count')[0].textContent);
    // Number of points to generate per parametric range. Use a hardcoded value for now
    var points = Math.round(1000 / tranges);
    // We need this to interpolate regression value when data point falls between
    //  regression curve points
    var pt_y_prev = null;
    eval('x_func = ' + pcurve.getElementsByTagName('x_func')[0].textContent);
    eval('y_func = ' + pcurve.getElementsByTagName('y_func')[0].textContent);
    
    for (var ti = 0; ti < tranges; ++ti) { //iterate over all piecewise ranges
        for (var p = 0; p < (points + 1); ++p) { //iterate by regular steps
            var t = p / (points + 1); //normalize t in interval [0,1]
            var point = [ x_func(t,ti), y_func(t,ti) ];
            var entry = [];
            entry.push(point[0]); //push the x-coord of the entry
            if (point[0] < data[0][0]) {
                entry.push(null); //if there is no data for original series, skip it
            } else {
                while ((data.length > 0) && (point[0] >= data[0][0])) {
                    var datapt = data.shift();
                    entry = [];
                    // NOTE: Here we also have to interpolate y for missing x-value
                    var y_intp = pt_y_prev == null? null : 0.5*(point[1] + pt_y_prev);
                    entry.push(datapt[0], datapt[1], y_intp);
                    pc_data.push(entry);
                }
                
                entry = [];
                entry.push(point[0]);
                entry.push(null);
            }
            pt_y_prev = point[1];
            entry.push( point[1] );
            pc_data.push( entry );
        }
    }
    
    while (data.length > 0) {
        var datapt = data.shift();
        var entry = [datapt[0], datapt[1], null];
        pc_data.push(entry);

    }
    
    //5. Draw Regression on the plot
    pc_labels = [];
    pc_colors = [];
    pc_opts = {};
    pc_opts['axes']={};
    pc_opts['xlabel']=xAxisText;
    pc_opts['ylabel']=yAxisText;
    //pc_opts['title'] =chartCaption; Title is unneccasary 
    pc_opts['avoidMinZero'] = true;
    pc_opts['highlightCircleSize'] = 4;
    pc_opts['highlightSeriesOpts'] = { pointSize: 5 };
    
    for (var i = 0; i < labels.length; ++i) {
        pc_labels.push(labels[i]);
        if (i > 0) { 
            pc_colors.push(orig_colors[i-1]);
            var label = labels[i] + " regression";
            pc_labels.push(label);
            var c = new RGBColor(orig_colors[i-1]);
            var cp = new RGBColor(orig_colors[i-1]); 
            // Transpose the color palette
            c.r = 0.5*(cp.b + cp.g);
            c.g = 0.5*(cp.r + cp.b);
            c.b = 0.5*(cp.r + cp.g);
            pc_colors.push(c.toHex());
            pc_opts[label] = {
                drawPoints: false,
                strokeWidth: 1.0
            };
        }
    }
    pc_opts['xAxisLabelWidth'] = 100;
    pc_opts['axes']['x'] = {
                axisLabelFormatter: getFormatterFunc(folding_kind, deltaX),
                valueFormatter: getFormatterFunc(folding_kind, deltaX) 
            };
    pc_opts['axes']['y'] = {
                valueFormatter: getFormatterFunc(null, deltaY) ,
                axisLabelFormatter: getFormatterFunc(null, deltaY) 
            };
    
    if (null != folding_kind) {
        pc_opts['axes']['x']['pixelsPerLabel'] = 100;
    }        
    
    
    pc_opts.file = pc_data;
    pc_opts.labels = pc_labels;
    pc_opts.colors = pc_colors;
    graph.updateOptions(pc_opts);
}

/* 
 * This function looks at the data received and draws an appropriate
 * graphical object.
 *
 */
function displayLoadedData(xmldata) {
    
    var regressionEls = xmldata.getElementsByTagName("regression");
    var onefactorsEls = xmldata.getElementsByTagName("onefactor");
    var discretesEls = xmldata.getElementsByTagName("discrete");
    
    var regressions = []; var onefactors = []; var discretes = [];
    
    var query = xmldata.getElementsByTagName("regression");
    for (var i = 0; i < regressionEls.length; ++i) {
        regressions.push(regressionEls[i]);
    }
    query = xmldata.getElementsByTagName("onefactor");
    for (var i = 0; i < query.length; ++i) {
        onefactors.push(query[i]);
    }
    query = xmldata.getElementsByTagName("discrete");
    for (var i = 0; i < query.length; ++i) {
        discretes.push(query[i]);
    }

    
    // We have to do this first, because dygraphs might throw an error if 
    // there is no data
    try {
        var dataset_obj = xmldata.getElementsByTagName('dataset');
        if (dataset_obj.length > 0) {
            dataset_obj = dataset_obj[0];
            document.getElementById("experiment_data_points").innerHTML = dataset_obj.getAttribute("size");
        } else {
            document.getElementById("experiment_data_points").innerHTML= "0.";
        }
        
        var experiment_analysis_summary = xmldata.getElementsByTagName('summary');
        if (experiment_analysis_summary.length > 0) {
            experiment_analysis_summary = experiment_analysis_summary[0];
            if (experiment_analysis_summary.childNodes.length > 0) {
                experiment_analysis_summary = experiment_analysis_summary.childNodes[0].nodeValue;
                document.getElementById("experiment_analysis_summary").innerHTML=experiment_analysis_summary;
            } else {
                document.getElementById("experiment_analysis_summary").innerHTML="No information available.";
            }
        }
    } catch (e) {}
    
    
    try {
        if (regressions.length > 0) { drawChart(xmldata);            }
        if ( onefactors.length > 0) { drawCandleStickChart(xmldata); }
        if (  discretes.length > 0) { drawColumnChart(xmldata);      }
    } catch (e) {
        document.getElementById("chart_div").innerHTML = 
            "<img style=\"width: 600px; height: 400px; padding: 10px;\"" 
            + " class=\"loading_icon\" src=\"/static/images/no_data_slug.png\"></img>";
    }
}

function loadChartData(url) {
	
	document.getElementById("chart_div").innerHTML = "<img class=\"loading_icon\" src=\"/static/images/ajax-loader.gif\"></img>";
	document.getElementById("experiment_analysis_summary").innerHTML = "<img class=\"loading_icon\" src=\"/static/images/ajax-loader.gif\"></img>";
	document.getElementById("experiment_data_points").innerHTML = "<img class=\"loading_icon\" src=\"/static/images/ajax-loader.gif\"></img>"; 
	
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var xmldata = xmlhttp.responseXML;
			displayLoadedData(xmldata);
		}
	}


	xmlhttp.open("GET",url,true);
	xmlhttp.send();
}

function loadDefaultChart() {
	setFilter(0);
}

function setFilter(filter) {
	var url = "/data/{{ exp.pk }}/?filter="+ filter;
	loadChartData(url);
	
	var me = document.getElementById("filter_me");
	var friend = document.getElementById("filter_friends");
	var everyone = document.getElementById("filter_everyone");

	me.className = "filter filter_unselected";
	friend.className = "filter filter_unselected";
	everyone.className = "filter filter_unselected";
	
					
	if (filter == 0) {
		everyone.className = "filter filter_selected";
	} else if (filter == 1) {
		me.className = "filter filter_selected";
	} else if (filter == 2) {
		friend.className = "filter filter_selected"
	}
}

function loadUserTable() {
	var url = "/data/{{ exp.pk }}/?filter=1";
	
	var xmlhttp = getXHR();
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var xmldata = xmlhttp.responseXML;
			drawUserTable(xmldata);
		}
	}

	xmlhttp.open("GET",url,true);
	xmlhttp.send();
}

function drawUserTable(xmldata) {
	var data = new google.visualization.DataTable();

	var chartElement = xmldata.getElementsByTagName("chart")[0];
	
	data.addColumn('string', chartElement.getAttribute("xAxisName"));
	data.addColumn('string', chartElement.getAttribute("yAxisName"));
	data.addColumn('string', 'Comment');
	
	var datasetElement = xmldata.getElementsByTagName("dataset")[0];
	var dataElements = datasetElement.getElementsByTagName("set");
    
    /* Need to be able to pull mappings of the experiment types */
    {% if exp.x_type == 'c' %}
        var xMapping = {};
		xMapping = loadLabelMapping(xmldata, 'x');
    {% endif %}
    {% if exp.y_type == 'c' %}
        var yMapping = {};
		yMapping = loadLabelMapping(xmldata, 'y');
    {% endif %}
    {% if exp.x_type == 't' %}
        var xMin = parseFloat(xmldata.getElementsByTagName("xmin")[0].childNodes[0].nodeValue);
        var xMax = parseFloat(xmldata.getElementsByTagName("xmax")[0].childNodes[0].nodeValue);
        var timefold = xmldata.getElementsByTagName("timefold")[0].getAttribute("period");
        var xTimeFmtFunc = getFormatterFunc(timefold, xMax-xMin);
    {% endif %}
    
	data.addRows(dataElements.length + 1);

	for (var i = 0; i < dataElements.length; i++) {
		var dataElement = dataElements[i];
        var x = dataElement.getAttribute("x");
		var y = dataElement.getAttribute("y");
        {% if exp.x_type == 'c' %} x = xMapping[parseInt(x)]; {% endif %}
        {% if exp.y_type == 'c' %} y = yMapping[parseInt(y)]; {% endif %}
        {% if exp.x_type == 't' %} x = xTimeFmtFunc(x); {% endif %}
		data.setCell(i, 0, x);
		data.setCell(i, 1, y);
		data.setCell(i, 2, dataElement.getAttribute("comment"));
	}
	
    var xinputCpy = dojo.clone( dojo.byId('x_entry_prototype') );
    var yinputCpy = dojo.clone( dojo.byId('y_entry_prototype') );
    xinputCpy.id = 'x_entry';
    yinputCpy.id = 'y_entry';
    var xinputWrap = document.createElement("div");
    var yinputWrap = document.createElement("div");
    dojo.place(xinputCpy, xinputWrap);
    dojo.place(yinputCpy, yinputWrap);    
    
	data.setCell(dataElements.length, 0, xinputWrap.innerHTML)
	data.setCell(dataElements.length, 1, yinputWrap.innerHTML)
	data.setCell(dataElements.length, 2, "<input class=\"inputselect\" id=\"comment_entry\" type=\"text\" />")
	
	var table = new google.visualization.Table(document.getElementById('table_div'));
	var cssClassNames = {headerRow: 'data_table_header_row', tableRow: 'data_table_row',
						 selectedTableRow : 'data_table_selected_row', tableCell: 'data_table_cell',
						 headerCell: 'data_table_header_cell' };
	table.draw(data, {cssClassNames: cssClassNames, showRowNumber: false, page: 'enable', pageSize: 5, startPage:(Math.ceil((dataElements.length+1)/5) - 1) , allowHtml:true });
}

function disableButton(button) {
	button.disabled = true;
}

function enableButton(button) {
	button.disabled = false;
}


function addDataEntry() {
    
	var x = document.getElementById("x_entry").value;
	var y = document.getElementById("y_entry").value;
	var comment = document.getElementById("comment_entry").value;
    
    // We need to format the time to a specific string format before
    // sending it over to our server
    {% if exp.x_type == 't' %}
        x = Date.parse(x);
        if (isNaN(x)) { 
            x = document.getElementById("x_entry").backup;
            x = Date.parse(x);
        }
        x = new Date(x);
        x = formatForServerInUTCString(x);
    {% endif %}
    
    disableButton(document.getElementById("add_entry_button"));
	
	var url = "/submit/{{ exp.pk }}/";
	var params = "x=" + encodeURI (x) + "&y=" + encodeURI (y) + "&comments=" + encodeURI (comment);
	
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			var xmldata = xmlhttp.responseXML;
			loadUserTable();	
			enableButton(document.getElementById("add_entry_button"));
		}
	}

	xmlhttp.open("POST",url,true);
	xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xmlhttp.send(params);
}
</script>
<style type="text/css">
#filter_selector {
	font-size: 14pt;
}

.filter {
	padding: 0px 5px 0px 5px;
}

.filter_selected {
	background-color:#EEE;
}

.filter_unselected {
	
}

</style>

{% endblock %}

{% block content %}
		
    <div style="display:none;" id="hidden_inputs"> 
        <!-- a wrapper for x_choices input controls -->
        <div>
        {% if x_choices != None %}
                <select id="x_entry_prototype" class="inputselect" name="x_entry">
                    {%  for choice in x_choices %}
                        <option value="{{choice.order}}">{{ choice.option }}</option>
                    {% endfor %}
                </select>
        {% else %}
        
            {% if exp.x_type == 't' %}
                <script type="text/javascript">
                    function fixBrokenTime(what) {
                        var date = null;
                        try {
                            date = Date.parse(what.value);
                        } catch (e) {}
                        if (isNaN(date)) {
                            //try to restore the input
                            if (typeof what.backup != 'undefined') {
                                what.value = what.backup;
                                return;
                            } else {
                                date = new Date();
                                what.value = date.toString();
                                what.backup = what.value;
                            }
                        } else {
                            what.backup = new Date(date).toLocaleString();
                        }
                    };
                    
                </script>
                <input id="x_entry_prototype" class="inputtxt" onfocus="fixBrokenTime(this)" onblur="fixBrokenTime(this)" type="text" />
            {% else %}
                <input id="x_entry_prototype" class="inputtxt" type="text" />

            {% endif  %}
                        
            
        {% endif %}
        </div>
        
        <!-- a wrapper for y_choices input controls -->
        <div>
        {% if y_choices != None %}
                <select id="y_entry_prototype" class="inputselect" name="y_entry">
                    {%  for choice in y_choices %}
                        <option value="{{choice.order}}">{{ choice.option }}</option>
                    {% endfor %}
                </select>
        {% else %}
            <input id="y_entry_prototype" class="inputtxt" type="text" />
        {% endif %}
        </div>

        
    </div>
    
    <div style="width: 700px; margin-top: 30px;" class="experiment centered_box rounded_shaded_big_box">
    	<div style="position: relative">
            <div class="experiment_vote_box" style="position: absolute; margin-left: 10px; width: 60px; height: 70px; top: 20px; left: -100px;">
                <div style="position: absolute;">
                    <div style="position:relative; left: 3px; top: 10px;"><a
						{% if request.user.is_authenticated %}
							href="" 
							onclick="vote(true); return false;"
						{% else %}
							href="/login"
						{% endif %}
					><img src="/static/images/uparrow.png" /></a></div>
                    <div style="position:relative; left: 3px; top: 18px;"><a
						{% if request.user.is_authenticated %}
							href="" 
							onclick="vote(false); return false;"
						{% else %}
							href="/login"
						{% endif %}
					><img src="/static/images/downarrow.png" /></a></div>
                </div>
                <div style="position: absolute; left: 20px;">
                    <span id="votetotal" class="experiment_number centered_box" style="width: 50px; text-align: center;">{{ exp.votes }}</span>
                </div>
                <div class="experiment_number_desc" style="position: absolute; top: 50px; left: 10px;">votes</div>
              
            </div>
        </div>
    
        <div class="box_header">experiment</div>
    
        <div class="rounded_small_box experiment_box centered_box" style="width: 650px;">
            <table class="rounded_table" style="table-layout: auto; width: 100%;">
                <tr>
                    <td style="width: 50px; font-size: 10px; padding: 0px; padding-left: 3px;">how</td>
                    <td style="width: 100px;"><strong>{{ exp.x_name }}</strong></td>
					<td style="width: 100%">
                    {% if exp.x_type == 'c' %}
                        One of {% for choice in exp.choicesX %}{% if not forloop.first %}, {% endif %}{{ choice.option }}{% endfor %}
                    {% else %}
                        In units of {{ exp.x_units }}
                    {% endif %}
					</td>
                </tr>
                <tr>
                    <td style="width: 50px; font-size: 10px; padding: 0px; padding-left: 3px;">affects</td>
                    <td style="width: 100px;"><strong>{{ exp.y_name }}</strong></td>
					<td style="width: 100%">
                    {% if exp.y_type == 'c' %}
                        One of {% for choice in exp.choicesY %}{% if not forloop.first %}, {% endif %}{{ choice.option }}{% endfor %}
                    {% else %}
                        In units of {{ exp.y_units }}
                    {% endif %}
					</td>
                </tr>
                <tr>
                    <td colspan="3" style="font-size: 15px;">
                        <!-- <span style="font-size: 10px;">description</span><br /> -->
                        {{ exp.description }}
                    </td>
                </tr>
                <tr>		
                    <td style="width: 50px; font-size: 10px; padding: 0px; padding-left: 3px;">owner</td>
                    <td colspan="2"><a href="/user/{{ exp.user }}/">{{ exp.user }}</a></td>
                </tr>
                <tr>
                    <td style="width: 50px; font-size: 10px; padding: 0px; padding-left: 3px;">created</td>
                    <td colspan="2">{{ exp.created }}</td>
                </tr>
            </table>
        </div>
   		<p class="clear"></p>
        <div class="box_header">data</div>
    
        <!--<script type="text/javascript" src="https://www.google.com/jsapi"></script>-->
        <script type="text/javascript">
          google.load("visualization", "1", {packages:["corechart"]});
          google.setOnLoadCallback(loadDefaultChart);
        </script>

        <div class="rounded_small_box centered_box" style="width: 650px; ">
            
            <div id="chart_div" style="width: 600px; height: 400px; padding: 10px;">
            </div>
            <div id="filter_selector" style="text-align: center; margin-top: 20px;">
                <a id="filter_me" class="filter filter_unselected" href="" onclick="setFilter(1); return false;">me</a>
                <a id="filter_friends" class="filter filter_unselected" href="" onclick="setFilter(2); return false;">friends</a>
                <a id="filter_everyone" class="filter filter_unselected" href="" onclick="setFilter(0); return false;">everyone</a>
            </div>
        </div>
    	<p class="clear"></p>
        <div class="box_header">analysis</div>
        <div id="experiment_regression" class="rounded_small_box experiment_box centered_box" style="width: 650px;">
            
             <table class="rounded_table" style="table-layout: fixed; width: 100%;">
                <tr>
                    <td style="width: 100px;">Correlation</td>
                    <td style="width: 100%"><span id="experiment_analysis_summary"></span></td>
                </tr>
                <tr>
                    <td style="width: 100px;">Data points</td>
                    <td style="width: 100%"><span id="experiment_data_points"></span></td>
                </tr>
                <tr>
                    <td style="width: 100px;">Participants</td>
                    <td style="width: 100%">{{ exp.subscription_set.all.count }}</td>
                </tr>
             
            </table>
            
            
        </div>
        
        <br />
        <br />
            
        <div class="box_header">your data</div>
        
        <div style="width: 630px; padding: 10px;" class="centered_box rounded_small_box">
            {% if not request.user.is_authenticated %}
            <a href="/login">Login</a> to submit data and comments.
            {% else %}
                
                <script type='text/javascript'>
				  google.load('visualization', '1', {packages:['table']});
				  google.setOnLoadCallback(loadUserTable);
				</script>
                <div id='table_div'></div>
                
                {% if subscription %}
                <input id="add_entry_button" type="submit" value="Add Entry" onclick="addDataEntry();" />
                {% else %}
                    <a href="/join/{{exp.pk}}/">Join experiment</a> to submit data.
                {% endif %}    
           
            {% endif %}
    	</div>
    </div>


<p class="clear" style="clear:both"></p>


<div class="experiment_comments_section centered_box" style="width: 650px; margin-top: 50px;">
<div style="margin-bottom: 0px; padding-bottom: 0px;" class="box_header">{{ comments.count }} comments</div>
<hr style="position: relative; left: -30px; margin-top: 0px; padding-top: 0px; width: 650px;" />
    {% for cmnt in comments %}
        <div style="margin-bottom: 10px;">
            <span class="experiment_comment_username"> <a href="/user/{{cmnt.user.username}}/">{{cmnt.user.username}}</a></span><span class="experiment_comment_extra"> posted {{ cmnt.tstamp }}</span>
            <div class="experiment_comment_text">
              {{ cmnt.message }}
            </div>
        </div>
 

    {% empty %}
    No comments submitted.
    {% endfor %}
    <br />
    
    <div class="experiment_comments_submission">
    {% if request.user.is_authenticated %}
        <div width="400px">
            <form action="/postcomm/{{ exp.pk }}/" method="post">
           
              <input type="hidden" name="title" value=""></input>
              <textarea name="message" rows="3" cols="60" onfocus="if (! this.cleared) { this.value = ''; this.cleared = 1; }">Enter your comment</textarea><br />
              <input type="submit" value="Post">
            
            </form>
        </div>
	{% endif %}	
    </div>
</div>

{% endblock %}

