{% extends 'base.html' %}

{% block title %}Experiment{% endblock %}


{% block extrahead %}
<script language="JavaScript" src="/static/Charts/FusionCharts.js"></script>
<script language="javascript">
function vote(val) {
		
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			xml = xmlhttp.responseXML
			total = xml.getElementsByTagName("total")[0]
			document.getElementById("votetotal").innerHTML=total.childNodes[0].nodeValue;
		}
	}
	  
	if (val) {
		xmlhttp.open("GET","/upvote/{{ exp.id }}/",true);
	} else {
		xmlhttp.open("GET","/downvote/{{ exp.id }}/",true);
	}
	xmlhttp.send();
	
}
</script>

{% endblock %}

{% block content %}
<div class="experiment_number experiment_vote" style="float: left;">
	<div style="float: left; margin-left: 5px;">
        <span id="votetotal">{{ exp.votes }}</span>
        <div class="experiment_number_desc">votes</div>
    </div>
<div style="float: left;">
    	<div style="position:relative; left: 3px; top: 5px;"><a href="" onclick="vote(true); return false;"><img src="/static/images/uparrow.png" /></a></div>
   	<div style="position:relative; left: 3px; top: 13px;"><a href="" onclick="vote(false); return false;"><img src="/static/images/downarrow.png" /></a></div>
  </div>
</div>

<div style="float: left; max-width: 650px; margin-left: 10px">
    <h1 style="margin-top: 0px;">{{ exp.y_name }} with {{ exp.x_name }}</h1>
    {{ exp.description }}
  
</div>
<p style="clear: both"></p>

<div style=" padding: 10px 10px">
<span class="" style="font-weight: bold; font-size: 11pt;">{{ exp.y_name }}</span> measured in {{ exp.y_units }}.<br>
{{ exp.y_control }}<br><br>

<span class="" style="font-weight: bold; font-size: 11pt;">{{ exp.x_name }}</span> is measured in {{ exp.x_units }}.<br>
{{ exp.x_control }}
</div> 

<br>

    

<h2>Experiment data</h2>
<div id="chartdiv" align="center"> FusionCharts. </div>
<script type="text/javascript">
	var chart = new FusionCharts("/static/Charts/Scatter.swf", "ChartId", "560", "400", "0", "0");
	
	chart.setXMLUrl("/data/{{ exp.pk }}/");		   
 	chart.render("chartdiv");
</script>
<br>
<div id="regression" style="border:1px solid grey; padding: 10px 10px">
Analysis:<br>
{{ regression.summary }}
</div>


<h2>Your Data</h2>
<div style="border:1px solid grey; padding: 10px 10px">
{% if not request.user.is_authenticated %}
Login to submit data.
{% else %}
    
    {% if user_data %}
        Your {% if user_data.size > 1 %}submissions{% else %}submission{% endif %}:<br>
        {% for data in user_data %}
            {{ exp.x_name }}: {{ data.x }}, {{ exp.y_name }}: {{ data.y }}<br>
        {% endfor %}
    {% else %}
    
        {% if subscription %}
      
            <form action="/unjoin/{{ exp.pk }}/" method="get">
           	 <input type="submit" value="Leave Experiment">
            </form>

            Submit your own data:<br><br>
            <form action="/submit/{{ exp.pk }}/" method="post">
            <table>
            <tr>
                <td>{{ exp.x_name }}:</td>
                <td><input type="number" name="x"/></td>
            </tr>
            <tr>
                <td>{{ exp.y_name }}:</td>
                <td><input type="number" name="y"/></td>
            </tr>
            <tr>
                <td>Comments:</td>
                <td><input type="text" name="comments"/></td>
            </tr>
            </table>
            <br>
            <input type="submit" value="Submit Data">
            </form>
        {% else %}
            <form action="/join/{{ exp.pk }}/" method="get">
            <input type="submit" value="Join Experiment">
            </form>
        {% endif %}

        	
    {% endif %}

{% endif %}
</div>

<h2>Experiment Discussion</h2>
{% for cmnt in comments %}
	<div style="border:1px solid grey; padding: 10px 10px">
	<table>
	{% if not cmnt.title == "" %}
	<tr><td>
		<b>{{ cmnt.title }}</b><br/>
	</td></tr>
	{% endif %}
	<tr><td><i>By {{cmnt.user.username}} at {{ cmnt.tstamp }}</i> </td></tr>
	<tr><td>{{ cmnt.message }}</td></tr>
	<!--  TODO: Threaded commenting	 -->
	<!-- <tr><td><button type="button" id="Reply">Reply</button></td></tr> -->
	</table>
	
 	</div>
{% endfor %}

<h2>Post Comments</h2>
<div style="border:1px solid grey; padding: 10px 10px" width="100%">
    {% if not request.user.is_authenticated %}
		<p>Login to post comments.</p>
	{% else %}
		{% if not authed %}
			<p>Login to post comments.</p>
		{% else %}
		
			<form action="/postcomm/{{ exp.pk }}/" method="post">
            <table width="100%">
            	<tr><td width="100%">Title: &nbsp; &nbsp; <input type="text" name="title"></input></td></tr>
            	<tr><td width="100%"><textarea name="message" rows="4" cols="80">Enter your comment</textarea></td></tr>
            </table>
            <br>
            <input type="submit" value="Comment!">
            </form>
            
		{% endif %}
	{% endif %}	
</div>

{% endblock %}



