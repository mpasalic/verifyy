{% extends 'base.html' %}

{% block title %}Experiment{% endblock %}


{% block extrahead %}
<script language="JavaScript" src="/static/Charts/FusionCharts.js"></script>
<script language="javascript">
function vote(val) {
		
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			xml = xmlhttp.responseXML
			total = xml.getElementsByTagName("total")[0]
			document.getElementById("votetotal").innerHTML=total.childNodes[0].nodeValue;
		}
	}
	  
	if (val) {
		xmlhttp.open("GET","/upvote/{{ exp.id }}/",true);
	} else {
		xmlhttp.open("GET","/downvote/{{ exp.id }}/",true);
	}
	xmlhttp.send();
	
}

function analysis(url) {
		
	var xmlhttp;
	if (window.XMLHttpRequest)
	{// code for IE7+, Firefox, Chrome, Opera, Safari
	  	xmlhttp=new XMLHttpRequest();
	}
	else
	{// code for IE6, IE5
	 	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	document.getElementById("regression_summary").innerHTML = "Loading data...";
	
	xmlhttp.onreadystatechange=function()
	{
	  	if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			xml = xmlhttp.responseXML
			total = xml.getElementsByTagName("regression")[0]
			document.getElementById("regression_summary").innerHTML=total.childNodes[0].nodeValue;
		}
	}

	xmlhttp.open("GET",url,true);
	xmlhttp.send();
	
}
</script>
<style type="text/css">
#filter_selector {
	font-size: 14pt;
}

.filter {
	padding: 0px 5px 0px 5px;
}

.filter_selected {
	background-color:#EEE;
}

.filter_unselected {
	
}

</style>

{% endblock %}

{% block content %}

<div id="addthis" style="float: right; width: 140px">
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4e395cd66332e336"></script>
<!-- AddThis Button END -->
</div>

<div class="" style="float: left;">
	<div class="experiment_number experiment_vote">
        <div style="float: left; margin-left: 5px;">
            <span id="votetotal">{{ exp.votes }}</span>
            <div class="experiment_number_desc">votes</div>
        </div>
        <div style="float: left;">
            <div style="position:relative; left: 3px; top: 5px;"><a href="" onclick="vote(true); return false;"><img src="/static/images/uparrow.png" /></a></div>
            <div style="position:relative; left: 3px; top: 13px;"><a href="" onclick="vote(false); return false;"><img src="/static/images/downarrow.png" /></a></div>
        </div>
    </div>
        <div style="text-align: left; margin-top: 10px; margin-left: 5px;">
{% if subscription %}
		<a href="/unjoin/{{exp.pk}}/">leave</a><br />
{% else %}
        <a href="/join/{{exp.pk}}/">join</a><br />
{% endif %}
		<a href="/report/{{exp.pk}}/">report</a><br />
{% if exp.user == request.user or request.user.is_superuser %}
        <a href="/edit/{{exp.pk}}/">edit</a><br />
{% endif %}
    </div>
	
</div>

<div style="float: left; max-width: 650px; margin-left: 10px">
    <h1 style="margin-top: 0px; margin-bottom: 0px; padding-bottom:0px;"><span class="y_name">{{ exp.y_name }}</span> <span class="with" style=" ">with</span> <span class="x_name">{{ exp.x_name }}</span></h1> 
<span class="demphasize">created by</span> <a href="/user/{{ exp.user.username }}/">{{ exp.user.username }}</a><br />
{{ exp.description }} 


<div style=" padding: 10px 0px">
    <span class="emphasize">{{ exp.y_name }}</span> measured in <span class="emphasize">{{ exp.y_units }}</span>.<br>
    {{ exp.y_control }}<br><br>
    
    <span class="emphasize">{{ exp.x_name }}</span> is measured in <span class="emphasize">{{ exp.x_units }}</span>.<br>
    {{ exp.x_control }}
</div> 

</div>
<p style="clear: both"></p>

<div id="chartdiv" style="width: 740px; height: 400px"></div>

<br />
<div id="regression" class="boxed" style="margin-left: auto; margin-right: auto; width: 400px;">
    <h2>Analysis</h2>
    <div id="regression_summary"></div>
</div>

<div id="filter_selector" style="text-align: center; margin-top: 20px;">
	<a id="filter_me" class="filter filter_unselected" href="" onclick="setfilter(1); return false;">me</a>
    <a id="filter_friends" class="filter filter_unselected" href="" onclick="setfilter(2); return false;">friends</a>
    <a id="filter_everyone" class="filter filter_unselected" href="" onclick="setfilter(0); return false;">everyone</a>
</div>

<script type="text/javascript">
	var chart = new FusionCharts("/static/Charts/Scatter.swf", "ChartId", "740", "400", "0", "0");
	
	function setfilter(filter) {
		chart.setXMLUrl("/data/{{ exp.pk }}/?filter="+ filter);
		analysis("/data/{{ exp.pk }}/?filter="+ filter);
		
		var me = document.getElementById("filter_me");
		var friend = document.getElementById("filter_friends");
		var everyone = document.getElementById("filter_everyone");

		me.className = "filter filter_unselected";
		friend.className = "filter filter_unselected";
		everyone.className = "filter filter_unselected";
		
						
		if (filter == 0) {
			everyone.className = "filter filter_selected";
		} else if (filter == 1) {
			me.className = "filter filter_selected";
		} else if (filter == 2) {
			friend.className = "filter filter_selected"
		}
		
		
		
	}
	setfilter(0);
 	chart.render("chartdiv");
	
</script>
<br>

<br />
{% if not request.user.is_authenticated %}
<a href="/login">Login</a> to submit data and comments.
{% else %}
	<h2>Data</h2>
    <form action="/submit/{{ exp.pk }}/" method="post">
    
    <table border="0" style="" cellspacing="0">
    
    {% if user_data or subscription %}
    	<thead>
        	<th>{{ exp.x_name }}</th>
            <th>{{ exp.y_name }}</th>
        </thead>
    {% endif %}
    
    {% if user_data %}
    	
        {% for data in user_data %}
        	<tr>
            	<td align="center">{{ data.x }}</td>
                <td align="center">{{ data.y }}</td>
                <td align="center">{{ data.comments }}</td>
            </tr>
        {% endfor %}
        	
    {% endif %}
    
    {% if subscription %}
      	<tr>
        	<td><input type="number" name="x"/></td>
            <td><input type="number" name="y"/></td>
            <td><textarea name="comments"  onfocus="if (! this.cleared) { this.value = ''; this.cleared = 1; }">Comments</textarea></td>
        </tr>
    </table>
    <input type="submit" value="Add Data Point">
    {% else %}
    </table>
     	Join experiment to submit data.
    {% endif %}
	
            
	</form>
{% endif %}

</div>

<h2>Experiment Discussion</h2>
{% for cmnt in comments %}
	<div style="">
    	<a href="/user/{{cmnt.user.username}}/">{{cmnt.user.username}}</a><span style="color:#666"> posted {{ cmnt.tstamp }}</span>
        <div>
          {{ cmnt.message }}
		</div>
	</div>
    <br />

{% empty %}
No comments submitted.
{% endfor %}
<br />

<div style="" width="100%">
    {% if request.user.is_authenticated %}
  <div width="400px">
        <form action="/postcomm/{{ exp.pk }}/" method="post">
       
          <input type="hidden" name="title" value=""></input>
       	  <textarea name="message" rows="3" cols="60" onfocus="if (! this.cleared) { this.value = ''; this.cleared = 1; }">Enter your comment</textarea><br />
       	  <input type="submit" value="Submit">
        
    	</form>
    </div>
	{% endif %}	
</div>

{% endblock %}

